@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8" />
    <title>Country Quiz</title>
    <style>
        @@import url('https://fonts.googleapis.com/css?family=Fjalla+One&display=swap');

        * {
            transition: all 0.25s ease-in-out;
        }

        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Fjalla One', sans-serif;
            background: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/38816/image-from-rawpixel-id-2210775-jpeg.jpg') center center no-repeat;
            background-size: cover;
            display: grid;
            align-items: center;
            justify-items: center;
            color: #2A293E;
        }

            body::before {
                content: "";
                position: absolute;
                inset: 0;
                background: linear-gradient(120deg, rgba(255, 200, 255, 0.15), rgba(149, 164, 255, 0.2));
                backdrop-filter: blur(3px);
                z-index: 0;
            }

            body * {
                position: relative;
                z-index: 1;
            }

        .container {
            background: #f8f4e5;
            padding: 50px 80px;
            border: 2px solid rgba(0, 0, 0, 1);
            box-shadow: 15px 15px 1px #ffa580, 15px 15px 1px 2px rgba(0, 0, 0, 1);
            max-width: 480px;
            width: 100%;
            text-align: center;
            animation: fadeSlideUp 0.8s ease-out;
            transform: perspective(1000px) rotateX(0deg);
            transition: transform 0.4s ease;
        }

            .container:hover {
                transform: perspective(1000px) rotateX(3deg);
            }

        h1 {
            font-size: 22pt;
            margin-bottom: 25px;
            color: #2A293E;
            letter-spacing: 1px;
            text-shadow: 2px 2px 0px #ffc8ff;
        }

        /* --- Флаг --- */
        #flag {
            width: 150px;
            border: 2px solid rgba(0, 0, 0, 1);
            border-radius: 4px;
            margin: 20px auto;
            display: block;
            box-shadow: 5px 5px 0px #95a4ff, 5px 5px 0px 1px rgba(0, 0, 0, 1);
            transform: scale(0.8) translateY(20px);
            opacity: 0;
            animation: flagPop 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @@keyframes flagPop {
            0%

        {
            transform: scale(0.8) translateY(20px);
            opacity: 0;
        }

        60% {
            transform: scale(1.1) translateY(-5px);
            opacity: 1;
        }

        100% {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        }

        /* --- Поле за отговор --- */
        input {
            display: block;
            width: 100%;
            font-size: 14pt;
            line-height: 28pt;
            margin-bottom: 25pt;
            border: none;
            border-bottom: 5px solid rgba(0, 0, 0, 1);
            background: #f8f4e5;
            padding-left: 5px;
            outline: none;
            color: rgba(0, 0, 0, 1);
            min-width: 250px;
        }

            input:focus {
                border-bottom: 5px solid #ffa580;
                box-shadow: 0 4px 10px rgba(255, 165, 128, 0.4);
            }

            input:hover {
                background-color: #fffef7;
                transform: translateY(-2px);
            }

        /* --- Бутони --- */
        button {
            background: linear-gradient(90deg, #ffa580, #95a4ff);
            border: 1px solid rgba(0, 0, 0, 1);
            box-shadow: 3px 3px 0px #95a4ff, 3px 3px 0px 1px #000;
            font-size: 14pt;
            font-family: 'Fjalla One', sans-serif;
            padding: 10px 25px;
            cursor: pointer;
            transition: all 0.25s ease-in-out;
        }

            button:hover {
                background: rgba(0, 0, 0, 1);
                color: white;
                transform: translateY(-2px) scale(1.03);
            }

            button:active {
                transform: translateY(2px);
                box-shadow: 2px 2px 0px #95a4ff, 2px 2px 0px 1px rgba(0, 0, 0, 1);
            }

        /* --- Резултати и точки --- */
        #message {
            margin-top: 10px;
            font-size: 14pt;
        }

        #score {
            margin-top: 20px;
            font-size: 15pt;
            font-weight: bold;
            color: #2A293E;
        }

        /* --- Бутон "Back" --- */
        #backButton {
            position: absolute;
            top: 20px;
            right: 25px;
            background: #f8f4e5;
            padding: 10px 18px;
            border: 2px solid rgba(0, 0, 0, 1);
            box-shadow: 3px 3px 0px #95a4ff, 3px 3px 0px 1px #000;
            font-size: 13pt;
            font-weight: bold;
            letter-spacing: 1px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

            #backButton:hover {
                background: linear-gradient(90deg, #ffa580, #95a4ff);
                color: white;
                transform: translateY(-2px) scale(1.05);
            }

        /* 🎵 Контрол на музиката */
        #muteButton {
            position: absolute;
            top: 20px;
            left: 25px; /* 👈 преместен вляво */
            background: #f8f4e5;
            padding: 10px 18px;
            border: 2px solid rgba(0, 0, 0, 1);
            box-shadow: 3px 3px 0px #95a4ff, 3px 3px 0px 1px #000;
            font-size: 13pt;
            font-weight: bold;
            letter-spacing: 1px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            z-index: 1000;
        }

            #muteButton:hover {
                background: linear-gradient(90deg, #ffa580, #95a4ff);
                color: white;
                transform: translateY(-2px) scale(1.05);
            }

            #muteButton:active {
                transform: translateY(2px);
            }

        /* --- Анимации --- */
        @@keyframes fadeSlideUp {
            from

        {
            opacity: 0;
            transform: translateY(40px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }
    </style>
</head>
<body>
    <button id="backButton" onclick="location.href='@Url.Action("Menu", "Home")'">🏠 Back</button>
    <button id="muteButton">🔊</button>

    <audio id="bgMusic" src="/sound/game.mp3" autoplay loop></audio>

    <div class="container">
        <h1>Guess the Country!</h1>
        <img id="flag" src="" alt="Flag" />
        <input id="answer" type="text" placeholder="Enter country name..." autocomplete="off" />
        <div>
            <button id="checkBtn">Check</button>
            <button id="nextBtn" style="margin-left:8px">Next</button>
        </div>
        <div id="message"></div>
        <div id="score">Score: 0</div>
    </div>

    <!-- 🎧 Музикален контрол -->
    <script>
        const bgMusic = document.getElementById('bgMusic');
        const muteButton = document.getElementById('muteButton');

        bgMusic.volume = 0.5;
        bgMusic.play().catch(() => {
            document.body.addEventListener('click', () => bgMusic.play(), { once: true });
        });

        muteButton.addEventListener('click', () => {
            bgMusic.muted = !bgMusic.muted;
            muteButton.textContent = bgMusic.muted ? '🔇' : '🔊';
        });
    </script>

    <!-- 🎮 JS логика -->
    <script src="~/js/quiz-logic.js"></script>

    <!-- 🧩 Твоят оригинален JS код остава непроменен -->
    <script>
        (function () {
            const flagEl = document.getElementById('flag');
            const msgEl = document.getElementById('message');
            const scoreEl = document.getElementById('score');
            const answerInput = document.getElementById('answer');
            const checkBtn = document.getElementById('checkBtn');
            const nextBtn = document.getElementById('nextBtn');

            let countries = [];
            let current = null;
            let score = 0;
            let combo = 0;
            let timerInterval = null;
            let timeLeft = 15;

            const correctSound = new Audio("/sound/correct.mp3");
            const wrongSound = new Audio("/sound/fail.mp3");

            let leaderboard = JSON.parse(localStorage.getItem("leaderboard") || "[]");

            const timerEl = document.createElement("div");
            timerEl.id = "timer";
            timerEl.style.marginTop = "10px";
            timerEl.style.fontSize = "13pt";
            timerEl.style.color = "#2A293E";

            const bestScoreEl = document.createElement("div");
            bestScoreEl.id = "bestScore";
            bestScoreEl.style.marginTop = "8px";
            bestScoreEl.style.fontSize = "13pt";

            const leaderboardEl = document.createElement("div");
            leaderboardEl.id = "leaderboard";
            leaderboardEl.style.marginTop = "15px";
            leaderboardEl.style.textAlign = "left";
            leaderboardEl.style.fontSize = "12pt";
            leaderboardEl.style.lineHeight = "1.4em";

            scoreEl.insertAdjacentElement("afterend", timerEl);
            timerEl.insertAdjacentElement("afterend", bestScoreEl);
            bestScoreEl.insertAdjacentElement("afterend", leaderboardEl);

            // 💓 стилове за комбо ефекти
            const style = document.createElement("style");
            style.innerHTML = `
            @@keyframes pulse {
                0% { transform: scale(1); color: red; text-shadow: 0 0 5px red; }
                50% { transform: scale(1.2); color: #ff7070; text-shadow: 0 0 15px #ff7070; }
                100% { transform: scale(1); color: red; text-shadow: 0 0 5px red; }
            }
            #timer.pulse {
                animation: pulse 1s infinite;
            }
            @@keyframes comboPop {
                0% { transform: scale(0.8); opacity: 0; }
                50% { transform: scale(1.3); opacity: 1; }
                100% { transform: scale(1); opacity: 0; }
            }
            #comboMessage {
                position: absolute;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 18pt;
                font-weight: bold;
                color: orange;
                text-shadow: 2px 2px 5px #ff0000;
                opacity: 0;
                pointer-events: none;
                animation: comboPop 1s ease;
            }
        `;
            document.head.appendChild(style);

            const comboMessage = document.createElement("div");
            comboMessage.id = "comboMessage";
            document.body.appendChild(comboMessage);

            function showComboEffect(text) {
                comboMessage.innerText = text;
                comboMessage.style.opacity = "1";
                comboMessage.style.animation = "none";
                comboMessage.offsetHeight;
                comboMessage.style.animation = "comboPop 1s ease";
            }

            function updateLeaderboardDisplay() {
                leaderboard = leaderboard.sort((a, b) => b.score - a.score).slice(0, 5);
                localStorage.setItem("leaderboard", JSON.stringify(leaderboard));
                const top = leaderboard.map((p, i) =>
                    `<div>⭐ ${i + 1}. <b>${p.name}</b> — ${p.score}</div>`
                ).join("");
                leaderboardEl.innerHTML = `<hr style='margin:8px 0;'>${top || "<i>No records yet.</i>"}`;
            }

            function startTimer() {
                clearInterval(timerInterval);
                timeLeft = 15;
                updateTimerDisplay();

                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();

                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        wrongSound.play();
                        msgEl.innerHTML = `<span style="color:red;">⏰ Time is up! That was ${current.name?.common || current.name}.</span>`;
                        setTimeout(() => endGame(), 1200);
                    }
                }, 1000);
            }

            function updateTimerDisplay() {
                timerEl.innerText = `⏱️ Time: ${timeLeft}s`;
                if (timeLeft <= 5) {
                    timerEl.classList.add("pulse");
                } else {
                    timerEl.classList.remove("pulse");
                    timerEl.style.color = "#2A293E";
                }
            }

            async function fetchWithTimeout(url, opts = {}, timeout = 10000) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                try {
                    const res = await fetch(url, { signal: controller.signal, ...opts });
                    clearTimeout(id);
                    return res;
                } catch (err) {
                    clearTimeout(id);
                    throw err;
                }
            }

            // 🌍 обновена функция - вече поддържа избран регион от менюто
            async function loadCountries() {
                msgEl.innerHTML = `<span style="color:#666">Loading countries...</span>`;
                try {
                    const selectedRegion = localStorage.getItem("region") || "all";
                    const url = 'https://restcountries.com/v3.1/all?fields=name,flags,cca2,region';
                    const res = await fetchWithTimeout(url, {}, 12000);
                    if (!res.ok) throw new Error('restcountries returned ' + res.status);
                    countries = await res.json();

                    // 💡 филтриране по континент
                    if (selectedRegion !== "all") {
                        countries = countries.filter(c =>
                            c.region?.toLowerCase() === selectedRegion.toLowerCase()
                        );
                    }

                    msgEl.innerHTML = `<span style="color:green">Loaded ${countries.length} countries (${selectedRegion.toUpperCase()} MODE)</span>`;
                } catch (err) {
                    msgEl.innerHTML = `<span style="color:red">Error loading countries!</span>`;
                    console.error(err);
                }
            }

            function pickRandom() {
                return countries[Math.floor(Math.random() * countries.length)];
            }

            function resolveFlagUrl(c) {
                const flags = c.flags || {};
                return flags.png || flags.svg || `https://flagcdn.com/w320/${(c.cca2 || '').toLowerCase()}.png`;
            }

            function showCountry(c) {
                current = c;
                answerInput.value = '';
                msgEl.innerHTML = '';
                const url = resolveFlagUrl(c);
                flagEl.style.display = 'none';
                flagEl.onload = () => (flagEl.style.display = 'block');
                flagEl.src = url;
                startTimer();
            }

            function nextQuestion() {
                clearInterval(timerInterval);
                if (!countries.length) return;
                showCountry(pickRandom());
            }

            function endGame() {
                clearInterval(timerInterval);
                timerEl.classList.remove("pulse");
                combo = 0;
                const name = prompt(`😅 Game over! Your score is ${score}.\nEnter your name to save your record:`);
                if (name && name.trim().length > 0) {
                    leaderboard.push({ name: name.trim(), score });
                    updateLeaderboardDisplay();
                }
                score = 0;
                scoreEl.innerText = `Score: ${score}`;
                nextQuestion();
            }

            function checkAnswer() {
                if (!current) return;
                clearInterval(timerInterval);

                const user = answerInput.value.trim().toLowerCase();
                if (!user) return;

                const correct = (current.name?.common || current.name || '').toLowerCase();

                if (user === correct) {
                    score++;
                    combo++;
                    correctSound.play();

                    if (combo > 1) msgEl.innerHTML = `<span style="color:green;">✅ Correct (${combo}x Combo!) — ${current.name?.common || current.name}</span>`;
                    else msgEl.innerHTML = `<span style="color:green;">✅ Correct — ${current.name?.common || current.name}</span>`;

                    if (combo % 3 === 0) {
                        score += 1;
                        showComboEffect(`🔥 COMBO x${combo}! +1 bonus!`);
                    }

                    scoreEl.innerText = `Score: ${score}`;
                    setTimeout(nextQuestion, 1300);
                } else {
                    wrongSound.play();
                    msgEl.innerHTML = `<span style="color:red;">❌ Wrong — it was ${current.name?.common || current.name}</span>`;
                    combo = 0;
                    setTimeout(endGame, 1000);
                }
            }

            checkBtn.addEventListener('click', checkAnswer);
            nextBtn.addEventListener('click', nextQuestion);
            answerInput.addEventListener('keydown', e => { if (e.key === 'Enter') checkAnswer(); });

            loadCountries().then(() => {
                nextQuestion();
                updateLeaderboardDisplay();
            });
        })();
    </script>


</body>
</html>

